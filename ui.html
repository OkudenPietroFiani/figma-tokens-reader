<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>W3C Design Tokens Importer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      font-size: 12px;
      line-height: 1.5;
      color: #333;
      background: #fff;
      padding: 16px;
    }

    .container {
      max-width: 100%;
      height: 100%;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #000;
    }

    h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #000;
    }

    .section {
      margin-bottom: 20px;
    }

    #file-input {
      display: none;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: #0d99ff;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #0b7fd4;
    }

    .btn-primary:active:not(:disabled) {
      background: #0a6eb8;
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-secondary {
      background: #fff;
      color: #333;
      border: 1px solid #e0e0e0;
      margin-top: 8px;
    }

    .btn-secondary:hover {
      background: #f5f5f5;
    }

    /* Messages */
    .message {
      display: none;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 12px;
      line-height: 1.5;
    }

    .message.visible {
      display: block;
    }

    .message.success {
      background: #e6f7e6;
      color: #006600;
      border: 1px solid #99dd99;
    }

    .message.error {
      background: #ffe6e6;
      color: #cc0000;
      border: 1px solid #ffb3b3;
    }

    .info-box {
      padding: 12px;
      background: #f0f8ff;
      border: 1px solid #b3d9ff;
      border-radius: 6px;
      font-size: 11px;
      color: #0066cc;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .info-box strong {
      font-weight: 600;
    }

    /* Tabs */
    .tabs {
      display: none;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      margin-bottom: 16px;
    }

    .tabs.visible {
      display: block;
    }

    .tab-buttons {
      display: flex;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
    }

    .tab-button {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      border-right: 1px solid #e0e0e0;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .tab-button:last-child {
      border-right: none;
    }

    .tab-button:hover {
      background: #e8e8e8;
    }

    .tab-button.active {
      background: #fff;
      color: #0d99ff;
      border-bottom: 2px solid #0d99ff;
      margin-bottom: -1px;
    }

    .tab-content {
      display: none;
      padding: 12px;
      max-height: 350px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 11px;
      line-height: 1.6;
      background: #fafafa;
    }

    .tab-content.active {
      display: block;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .json-key {
      color: #0066cc;
    }

    .json-string {
      color: #008000;
    }

    .json-number {
      color: #cc6600;
    }

    .json-boolean {
      color: #cc00cc;
    }

    .json-null {
      color: #999;
    }

    /* Loading */
    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      margin-top: 12px;
      color: #666;
      font-size: 12px;
    }

    .loading.visible {
      display: flex;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0e0;
      border-top-color: #0d99ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f0f0f0;
    }

    ::-webkit-scrollbar-thumb {
      background: #c0c0c0;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>W3C Design Tokens Importer</h1>

    <div class="info-box">
      <strong>Instructions:</strong> Click "Import Tokens" to upload a ZIP file containing <code>primitives.json</code> and <code>semantics.json</code>, or upload individual JSON files.
    </div>

    <!-- Import Message -->
    <div class="message" id="import-message"></div>

    <!-- Import Button Section -->
    <div class="section">
      <button class="btn btn-primary" id="import-btn">
        Import Tokens
      </button>
      <input type="file" id="file-input" accept=".zip,.json" multiple>
    </div>

    <!-- Tabs Section -->
    <div class="tabs" id="tabs-section">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="primitives">primitives.json</button>
        <button class="tab-button" data-tab="semantics">semantics.json</button>
      </div>
      <div class="tab-content active" id="primitives-tab">
        <div class="empty-state">No data imported</div>
      </div>
      <div class="tab-content" id="semantics-tab">
        <div class="empty-state">No data imported</div>
      </div>
    </div>

    <!-- Export Section -->
    <div class="section">
      <button class="btn btn-primary" id="export-btn" disabled>
        Import to Figma Variables
      </button>
      <button class="btn btn-primary" id="doc-btn" disabled style="margin-top: 12px;">
        Generate Documentation
      </button>
      <button class="btn btn-secondary" id="cancel-btn">
        Cancel
      </button>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Importing to Figma...</span>
      </div>
      <div class="loading" id="doc-loading">
        <div class="spinner"></div>
        <span>Generating documentation...</span>
      </div>
      <div class="message" id="export-message"></div>
      <div class="message" id="doc-message"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let primitivesData = null;
    let semanticsData = null;

    const fileInput = document.getElementById('file-input');
    const importBtn = document.getElementById('import-btn');
    const importMessage = document.getElementById('import-message');
    const tabsSection = document.getElementById('tabs-section');
    const primitivesTab = document.getElementById('primitives-tab');
    const semanticsTab = document.getElementById('semantics-tab');
    const exportBtn = document.getElementById('export-btn');
    const docBtn = document.getElementById('doc-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const loading = document.getElementById('loading');
    const docLoading = document.getElementById('doc-loading');
    const exportMessage = document.getElementById('export-message');
    const docMessage = document.getElementById('doc-message');
    const tabButtons = document.querySelectorAll('.tab-button');

    // Import button click
    importBtn.addEventListener('click', () => {
      fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', async (e) => {
      if (e.target.files.length === 0) return;

      // Hide previous messages
      importMessage.classList.remove('visible');
      exportMessage.classList.remove('visible');

      await handleFiles(e.target.files);
    });

    // Tab switching
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabName = button.dataset.tab;

        // Update button states
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabName + '-tab').classList.add('active');
      });
    });

    async function handleFiles(files) {
      try {
        // Reset data
        primitivesData = null;
        semanticsData = null;

        const file = files[0];

        if (file.name.endsWith('.zip')) {
          await handleZipFile(file);
        } else if (file.name.endsWith('.json')) {
          await handleJsonFiles(files);
        } else {
          showImportError('Please upload a .zip file or .json files');
          return;
        }

        if (primitivesData || semanticsData) {
          updateTabs();
          tabsSection.classList.add('visible');
          exportBtn.disabled = false;
          docBtn.disabled = false;

          const filesImported = [];
          if (primitivesData) filesImported.push('primitives.json');
          if (semanticsData) filesImported.push('semantics.json');

          showImportSuccess(`Successfully imported: ${filesImported.join(', ')}`);
        } else {
          showImportError('No valid token files found');
        }
      } catch (error) {
        showImportError(`Error loading file: ${error.message}`);
      }
    }

    async function handleZipFile(file) {
      const zip = new JSZip();
      const contents = await zip.loadAsync(file);

      // Look for primitives.json and semantics.json
      const primitivesFile = contents.file('primitives.json') ||
                            contents.file('primitive.json') ||
                            Object.keys(contents.files).find(f => f.includes('primitive') && f.endsWith('.json'));

      const semanticsFile = contents.file('semantics.json') ||
                           contents.file('semantic.json') ||
                           Object.keys(contents.files).find(f => f.includes('semantic') && f.endsWith('.json'));

      if (primitivesFile) {
        const text = await contents.files[primitivesFile].async('text');
        primitivesData = JSON.parse(text);
      }

      if (semanticsFile) {
        const text = await contents.files[semanticsFile].async('text');
        semanticsData = JSON.parse(text);
      }

      if (!primitivesData && !semanticsData) {
        throw new Error('No primitives.json or semantics.json found in ZIP file');
      }
    }

    async function handleJsonFiles(files) {
      for (const file of files) {
        const text = await file.text();
        const data = JSON.parse(text);

        if (file.name.includes('primitive')) {
          primitivesData = data;
        } else if (file.name.includes('semantic')) {
          semanticsData = data;
        } else {
          // Try to infer from content
          if (!primitivesData) {
            primitivesData = data;
          } else if (!semanticsData) {
            semanticsData = data;
          }
        }
      }
    }

    function updateTabs() {
      if (primitivesData) {
        primitivesTab.innerHTML = syntaxHighlight(JSON.stringify(primitivesData, null, 2));
      } else {
        primitivesTab.innerHTML = '<div class="empty-state">No primitives data</div>';
      }

      if (semanticsData) {
        semanticsTab.innerHTML = syntaxHighlight(JSON.stringify(semanticsData, null, 2));
      } else {
        semanticsTab.innerHTML = '<div class="empty-state">No semantics data</div>';
      }
    }

    function syntaxHighlight(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return '<pre>' + json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      }) + '</pre>';
    }

    // Export button
    exportBtn.addEventListener('click', async () => {
      if (!primitivesData && !semanticsData) {
        showExportError('Please import tokens first');
        return;
      }

      exportBtn.disabled = true;
      loading.classList.add('visible');
      exportMessage.classList.remove('visible');

      parent.postMessage({
        pluginMessage: {
          type: 'import-tokens',
          data: {
            primitives: primitivesData,
            semantics: semanticsData
          }
        }
      }, '*');
    });

    // Generate Documentation button
    docBtn.addEventListener('click', async () => {
      if (!primitivesData && !semanticsData) {
        showDocError('Please import tokens first');
        return;
      }

      docBtn.disabled = true;
      docLoading.classList.add('visible');
      docMessage.classList.remove('visible');

      parent.postMessage({
        pluginMessage: {
          type: 'generate-documentation'
        }
      }, '*');
    });

    // Cancel button
    cancelBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });

    // Listen for messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'import-success') {
        exportBtn.disabled = false;
        loading.classList.remove('visible');
        showExportSuccess(msg.message);

        // Close plugin after 2 seconds
        setTimeout(() => {
          parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
        }, 2000);
      } else if (msg.type === 'import-error') {
        exportBtn.disabled = false;
        loading.classList.remove('visible');
        showExportError(msg.message);
      } else if (msg.type === 'documentation-success') {
        docBtn.disabled = false;
        docLoading.classList.remove('visible');
        showDocSuccess(msg.message);

        // Close plugin after 3 seconds
        setTimeout(() => {
          parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
        }, 3000);
      }
    };

    function showImportSuccess(msg) {
      importMessage.textContent = msg;
      importMessage.className = 'message success visible';
    }

    function showImportError(msg) {
      importMessage.textContent = msg;
      importMessage.className = 'message error visible';
    }

    function showExportSuccess(msg) {
      exportMessage.textContent = msg;
      exportMessage.className = 'message success visible';
    }

    function showExportError(msg) {
      exportMessage.textContent = msg;
      exportMessage.className = 'message error visible';
    }

    function showDocSuccess(msg) {
      docMessage.textContent = msg;
      docMessage.className = 'message success visible';
    }

    function showDocError(msg) {
      docMessage.textContent = msg;
      docMessage.className = 'message error visible';
    }
  </script>
</body>
</html>
